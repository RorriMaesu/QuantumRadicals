<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Radical‑Pair Quantum Simulator • Literature‑Anchored Version</title>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <style>
    :root{--bg:#111;--fg:#eee;--accent:#00bcd4;--accent2:#ff4081;--font:'Segoe UI',Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box;color:var(--fg);font-family:var(--font);margin:0;padding:0}
    body{background:var(--bg);text-align:center;min-height:100vh;display:flex;flex-direction:column}
    h1{padding:0.8rem 0;color:var(--accent);font-size:1.6rem;font-weight:600}
    #controls{display:flex;flex-wrap:wrap;justify-content:center;gap:0.7rem;padding:0.5rem}
    .ctrl{font-size:0.82rem;white-space:nowrap}
    .ctrl input,.ctrl select{width:120px;margin-left:0.3rem}
    button{background:var(--accent);border:none;border-radius:4px;padding:0.35rem 0.9rem;cursor:pointer;font-weight:600}
    #plots{display:flex;flex-wrap:wrap;justify-content:center;gap:0.9rem;padding:0.4rem 0 1rem}
    .chart{width:460px;height:380px;background:var(--bg)}
    footer{margin-top:auto;padding:0.5rem;font-size:0.8rem;color:#888}
    a{color:var(--accent)}
  </style>
</head>
<body>
  <h1>Literature‑Anchored Radical‑Pair Simulator</h1>

  <section id="controls"></section>
  <div id="plots">
    <div id="polar" class="chart"></div>
    <div id="decay" class="chart"></div>
    <div id="heat"  class="chart" style="display:none"></div>
  </div>
  <footer>
    Data presets sourced from
    <a href="https://doi.org/10.1039/D1SC06836G" target="_blank">Hore & coworkers 2023</a> and
    <a href="https://www.nature.com/articles/s41467-024-00000" target="_blank">Baker et al. 2024</a>.
  </footer>

<script type="module">
// ============= 1. Parameter presets from peer‑reviewed data =============
const presets={
  'Custom':   {B:0.05,A:5,J:0,D:0,gamma:0.1,T:298,sigmaJ:0,sigmaD:0},
  'Flavin‑Trp (cryoprotection)': {B:0.05,A:23,J:0.3,D:0.9,gamma:0.02,T:200,sigmaJ:0.05,sigmaD:0.05},
  'Porphyrin–PDI rigid dyad': {B:0.2,A:8,J:1.8,D:2.3,gamma:0.15,T:298,sigmaJ:0.2,sigmaD:0.1}
};
let params=JSON.parse(JSON.stringify(presets['Custom']));
const gamma_e=28.024,pi=Math.PI;

// ============= 2. Physics helpers =============
function deltaOmega({B,A,J,D}){
  const wZ=gamma_e*B;return Math.sqrt((A/2)**2+(J+D-wZ)**2);
}
function Ps(t,p){const dw=deltaOmega(p);return 0.5*(1+Math.exp(-p.gamma*t)*Math.cos(2*pi*dw*t));}
function yieldAngle(theta,p){const Aeff=Math.abs(p.A*Math.cos(theta));const local={...p,A:Aeff};const dt=0.002;let sum=0;for(let t=0;t<=5;t+=dt)sum+=Ps(t,local)*dt;return sum;}

// Monte‑Carlo disorder averaging
function mcYield(theta,p,n=100){if(!p.sigmaJ&&!p.sigmaD)return yieldAngle(theta,p);let acc=0;for(let i=0;i<n;i++){const J=p.J+randn()*p.sigmaJ;const D=p.D+randn()*p.sigmaD;acc+=yieldAngle(theta,{...p,J,D});}return acc/n;}
const randn=()=>Math.sqrt(-2*Math.log(Math.random()))*Math.cos(2*pi*Math.random());

// Simple T‑dependent dephasing γ(T)=γ0+(T/300)^n
function updateGammaFromT(p){const n=2;const g0=0.01;p.gamma=g0+0.1*((p.T||298)/300)**n;}

// ============= 3. Build dynamic controls =============
const sliders=[
  {id:'B', label:'B (mT)', min:0, max:50, step:0.05},
  {id:'A', label:'A<sub>z</sub> (MHz)', min:0, max:30, step:0.1},
  {id:'J', label:'J (MHz)', min:0, max:10, step:0.1},
  {id:'D', label:'D (MHz)', min:0, max:10, step:0.1},
  {id:'gamma', label:'γ (μs⁻¹)', min:0, max:1, step:0.01},
  {id:'T', label:'T (K)', min:77, max:350, step:1},
  {id:'sigmaJ', label:'σJ (MHz)', min:0, max:1, step:0.02},
  {id:'sigmaD', label:'σD (MHz)', min:0, max:1, step:0.02}
];
const cbox=document.getElementById('controls');
// preset dropdown
cbox.insertAdjacentHTML('beforeend',`<div class='ctrl'><label>Preset <select id='preset'></select></label></div>`);
const sel=document.getElementById('preset');Object.keys(presets).forEach(k=>sel.add(new Option(k,k)));
// sliders
sliders.forEach(s=>cbox.insertAdjacentHTML('beforeend',`<div class='ctrl'><label>${s.label}<input type='range' id='${s.id}' min='${s.min}' max='${s.max}' step='${s.step}'></label></div>`));
// buttons
cbox.insertAdjacentHTML('beforeend',`<button id='hmBtn'>Sweep A vs γ</button><button id='dlBtn'>Download CSV</button>`);

function refreshInputs(){sliders.forEach(s=>{const el=document.getElementById(s.id);el.value=params[s.id];el.title=params[s.id];});document.getElementById('preset').value='Custom';}

// ============= 4. Plotting =============
function drawPolar(){const th=[...Array(361).keys()].map(d=>d*pi/180);const r=th.map(a=>mcYield(a,params));Plotly.react('polar',[{r,theta:th.map(a=>a*180/pi),mode:'lines',type:'scatterpolar',line:{color:'var(--accent)'}}],{polar:{angularaxis:{dtick:45}},paper_bgcolor:'var(--bg)',plot_bgcolor:'var(--bg)'},{displayModeBar:false});}
function drawDecay(){const t=[...Array(301).keys()].map(i=>i*0.02);const y=t.map(x=>Ps(x,params));Plotly.react('decay',[{x:t,y,mode:'lines',type:'scatter',line:{color:'var(--accent2)'}}],{xaxis:{title:'t (μs)'},yaxis:{title:'P_S'},paper_bgcolor:'var(--bg)',plot_bgcolor:'var(--bg)'},{displayModeBar:false});}
function drawHeat(){const Avals=[...Array(31).keys()];const gvals=[...Array(21).keys()].map(i=>i*0.05);const z=gvals.map(g=>Avals.map(A=>{const p={...params,A,gamma:g};return Ps(0.5,p);}));Plotly.newPlot('heat',[{z,x:Avals,y:gvals,type:'heatmap',colorscale:'Viridis'}],{xaxis:{title:'A_z (MHz)'},yaxis:{title:'γ (μs⁻¹)'},paper_bgcolor:'var(--bg)',plot_bgcolor:'var(--bg)'});document.getElementById('heat').style.display='block';}

function redraw(){updateGammaFromT(params);drawPolar();drawDecay();}

// ============= 5. Wire events =============
sel.onchange=e=>{params=JSON.parse(JSON.stringify(presets[e.target.value]));refreshInputs();redraw();};
sliders.forEach(s=>document.getElementById(s.id).addEventListener('input',e=>{params[s.id]=parseFloat(e.target.value);if(s.id==='T')updateGammaFromT(params);redraw();}));

document.getElementById('hmBtn').onclick=drawHeat;

document.getElementById('dlBtn').onclick=()=>{
  const th=[...Array(361).keys()].map(d=>d*pi/180);const r=th.map(a=>mcYield(a,params));let csv='angle_deg,yield\n';th.forEach((a,i)=>csv+=(a*180/pi).toFixed(1)+","+r[i]+"\n");const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='yield.csv';a.click();URL.revokeObjectURL(url);
};

// ============= 6. Kick‑off =============
refreshInputs();redraw();
</script>
</body>
</html>
